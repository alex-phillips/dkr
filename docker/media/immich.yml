version: "3.8"

services:
  immich-server:
    container_name: immich-server
    image: ghcr.io/immich-app/immich-server:v1.79.1
    networks:
      - data
      - external
    entrypoint: ["/bin/sh", "./start-server.sh"]
    volumes:
      - ${NAS}/docker/immich/data:/usr/src/app/upload
      - ${NAS}:${NAS}:ro
    env_file:
      - .env.immich
    depends_on:
      - redis
      - postgres
      - immich-typesense
    labels:
      app: immich
      auth: false
      ingress:
        - port: 3001
          host: photos.${SERVER_DOMAIN}
          rule: Host(`photos.${SERVER_DOMAIN}`) && PathPrefix(`/api`)
      traefik.http.middlewares.immich-server-0.stripprefix.prefixes: /api
      traefik.http.routers.immich-server-0.middlewares: immich-server-0

  immich-microservices:
    container_name: immich-microservices
    image: ghcr.io/immich-app/immich-server:v1.79.1
    networks:
      - data
      - external
    entrypoint: ["/bin/sh", "./start-microservices.sh"]
    volumes:
      - ${NAS}/docker/immich/data:/usr/src/app/upload
      - ${NAS}:${NAS}:ro
    env_file:
      - .env.immich
    environment:
      LOG_LEVEL: verbose
    depends_on:
      - redis
      - postgres
      - immich-typesense
    labels:
      app: immich

  immich-machine-learning:
    container_name: immich-machine-learning
    image: ghcr.io/immich-app/immich-machine-learning:v1.79.1
    networks:
      - data
      - external
    volumes:
      - ${NAS}/docker/immich/data:/usr/src/app/upload
      - ${NAS}/docker/immich/model-cache:/cache
      - ${NAS}:${NAS}:ro
    env_file:
      - .env.immich
    labels:
      app: immich

  immich-web:
    container_name: immich-web
    image: ghcr.io/immich-app/immich-web:v1.81.1
    networks:
      - data
      - external
    entrypoint: ["/bin/sh", "./entrypoint.sh"]
    env_file:
      - .env.immich
    labels:
      app: immich
      auth: false
      ingress:
        - port: 3000
          host: photos.${SERVER_DOMAIN}

  immich-typesense:
    container_name: immich-typesense
    image: typesense/typesense:0.25.1
    networks:
      - data
      - external
    env_file:
      - .env.immich
    environment:
      - TYPESENSE_DATA_DIR=/data
    volumes:
      - ${NAS}/docker/immich/tsdata:/data
    labels:
      app: immich

  # immich-proxy:
  #   container_name: immich-proxy
  #   image: ghcr.io/immich-app/immich-proxy:v1.75.0
  #   networks:
  #     - data
  #   # environment:
  #   #   # Make sure these values get passed through from the env file
  #   #   - IMMICH_SERVER_URL
  #   #   - IMMICH_WEB_URL
  #   env_file:
  #     - .env.immich
  #   depends_on:
  #     - immich-server
  #   labels:
  #     app: immich
  #     ingress:
  #       - port: 8080
  #         host: photos.${SERVER_DOMAIN}
