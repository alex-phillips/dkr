version: "3.3"
services:
  traefik:
    image: traefik:v2.9.8
    container_name: traefik
    networks:
      - web
      - dockerproxy
      - external
    depends_on:
      - dockerproxy
      - authelia
      - traefik-bouncer
    environment:
      - CF_API_EMAIL=ahp118@gmail.com
      - CF_API_KEY=${CLOUDFLARE_API_KEY}
    ports:
      - 80:80
      - 443:443
    volumes:
      - ${NAS}/docker/traefik:/etc/traefik
      - /var/log/traefik:/var/log/traefik
    labels:
      namespace: network
      port: 8080
      host: tr.${SERVER_DOMAIN}
      homepage.widget: true
      traefik.http.routers.traefik.tls.certresolver: letsencrypt
      traefik.http.routers.traefik.tls.domains[0].main: "${SERVER_DOMAIN}"
      traefik.http.routers.traefik.tls.domains[0].sans: "*.${SERVER_DOMAIN}"
      traefik.http.routers.traefik.tls.domains[1].main: "wootables.com"
      traefik.http.routers.traefik.tls.domains[1].sans: "*.wootables.com"

  dockerproxy:
    container_name: dockerproxy
    image: tecnativa/docker-socket-proxy
    privileged: true
    networks:
      - dockerproxy
    environment:
      CONTAINERS: 1
      POST: 0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
